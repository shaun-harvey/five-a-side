<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>five-a-side | Premier League Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --font-size-base: 16px;
      }

      @media (max-width: 640px) {
        :root {
          --font-size-base: 14px;
        }
      }

      body {
        font-family: "Poppins", sans-serif;
        font-size: var(--font-size-base);
      }

      #game-container {
        max-width: 90vw;
        width: 100%;
        padding: 1rem;
      }

      h1 {
        font-size: 2rem;
      }

      #round-info {
        font-size: 1.2rem;
      }

      #player-name {
        font-size: 1.8rem;
      }

      .letter-btn {
        font-size: 1rem;
        padding: 0.5rem;
      }

      #game-controls button {
        font-size: 1rem;
        padding: 0.5rem 1rem;
      }

      @media (min-width: 768px) {
        #game-container {
          max-width: 80vw;
          padding: 2rem;
        }

        h1 {
          font-size: 2.5rem;
        }

        #round-info {
          font-size: 1.5rem;
        }

        #player-name {
          font-size: 2rem;
        }

        .letter-btn {
          font-size: 1.2rem;
          padding: 0.75rem;
        }

        #game-controls button {
          font-size: 1.2rem;
          padding: 0.75rem 1.5rem;
        }
      }

      .blur-background {
        filter: blur(5px);
        transition: filter 0.3s ease-out;
      }

      .letter-btn {
        transition: all 0.3s ease;
      }

      .letter-btn:hover {
        transform: translateY(-2px);
      }

      .letter-btn.selected {
        background-color: #10b981;
      }

      .timer-bar {
        transition: width 1s linear;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .pulse {
        animation: pulse 2s infinite;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }

      @keyframes slideIn {
        from {
          transform: translateY(-20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }

      .fade-out {
        animation: fadeOut 0.5s ease-in-out;
      }

      .slide-in {
        animation: slideIn 0.5s ease-in-out;
      }

      .letter-reveal {
        transition: all 0.3s ease-in-out;
      }

      .hidden {
        display: none;
      }

      .mt-8 {
        margin-top: 2rem;
      }

      .mb-8 {
        margin-bottom: 2rem;
      }

      .space-y-8 > * + * {
        margin-top: 2rem;
      }
    </style>
  </head>
  <body class="bg-gray-900 min-h-screen flex items-center justify-center p-4">
    <div
      id="game-container"
      class="bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-4xl text-white space-y-8"
    >
      <h1 class="text-4xl font-bold text-center text-green-500">five-a-side</h1>
      <div id="select-letters-text" class="text-center mb-8">
        Select 5 letters to start the game
      </div>
      <div id="letter-grid" class="grid grid-cols-7 gap-2 mb-8"></div>
      <div id="game-info-section" class="hidden">
        <div
          id="round-info"
          class="text-xl font-semibold text-center text-blue-400 mb-4"
        >
          Round 1 of 3
        </div>
        <div
          id="timer-container"
          class="w-full bg-gray-700 rounded-full h-4 mb-4"
        >
          <div
            id="timer-bar"
            class="bg-red-600 h-4 rounded-full"
            style="width: 100%"
          ></div>
        </div>
        <div id="game-info" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
          <div
            id="timer"
            class="bg-red-800 rounded-lg p-2 text-center font-bold"
          >
            Time: 45s
          </div>
          <div
            id="score"
            class="bg-green-800 rounded-lg p-2 text-center font-bold"
          >
            Score: 0
          </div>
          <div
            id="substitutions"
            class="bg-yellow-800 rounded-lg p-2 text-center font-bold"
          >
            Subs: 5
          </div>
          <div
            id="guesses-left"
            class="bg-blue-800 rounded-lg p-2 text-center font-bold"
          >
            Guesses: 3
          </div>
        </div>
      </div>
      <div
        id="player-card"
        class="bg-gray-700 rounded-lg p-6 mb-8 shadow-inner hidden"
      >
        <div
          id="player-name"
          class="text-3xl font-bold text-center text-white tracking-wider h-12 font-mono"
        ></div>
      </div>
      <div
        id="current-team"
        class="text-center text-xl font-semibold text-white mb-4 hidden"
      >
        Your current team:
      </div>
      <div id="game-controls" class="hidden justify-center space-x-4 mb-6">
        <button
          id="solve"
          class="bg-green-600 hover:bg-green-500 text-white font-bold py-4 px-8 rounded-lg transition duration-300 text-xl"
        >
          Guess Player
        </button>
        <button
          id="substitute"
          class="bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-4 px-8 rounded-lg transition duration-300 text-xl"
        >
          Make a sub
        </button>
      </div>
      <button
        id="start-game"
        class="hidden w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-8 rounded-lg transition duration-300 text-xl"
      >
        Start Game
      </button>
      <button
        id="new-game"
        class="hidden w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-8 rounded-lg transition duration-300 text-xl"
      >
        New Game
      </button>
      <div
        id="message"
        class="text-center font-semibold text-blue-300 h-8"
      ></div>
      <button
        id="how-to-play-btn"
        class="absolute top-4 right-4 bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300"
      >
        How to Play
      </button>
    </div>

    <!-- Modals -->
    <div
      id="substituteModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center"
    >
      <div class="bg-gray-800 rounded-lg p-8 max-w-2xl w-full text-white">
        <h2 class="text-2xl font-bold text-center text-white mb-4">
          Choose letters to substitute
        </h2>
        <div
          id="current-player"
          class="text-center text-xl font-bold text-white mb-4"
        ></div>
        <div id="substitute-grid" class="grid grid-cols-5 gap-2 mb-4"></div>
        <div
          id="new-letters-grid"
          class="grid grid-cols-5 gap-2 mb-4 hidden"
        ></div>
        <button
          id="make-substitutions"
          class="w-full bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300 mt-4"
        >
          Make Substitutions
        </button>
      </div>
    </div>

    <div
      id="solveModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center"
    >
      <div class="bg-gray-800 rounded-lg p-8 max-w-md w-full text-white">
        <h2 class="text-2xl font-bold text-center text-white mb-4">
          Guess the player name
        </h2>
        <div
          id="solve-timer"
          class="text-xl font-semibold text-center text-red-500 mb-4"
        ></div>
        <input
          type="text"
          id="solve-input"
          placeholder="Enter player name"
          class="w-full p-2 border border-gray-600 rounded-lg mb-4 bg-gray-700 text-white"
        />
        <button
          id="submit-solve"
          class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300"
        >
          Submit
        </button>
      </div>
    </div>

    <div
      id="instructionsModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center"
    >
      <div class="bg-gray-800 rounded-lg p-8 max-w-2xl w-full text-white">
        <h2 class="text-2xl font-bold text-center text-green-500 mb-4">
          How to Play
        </h2>
        <ol class="space-y-2 text-gray-300 list-decimal list-inside">
          <li>
            <strong>Choose Letters:</strong> Start by selecting 5 letters from
            the grid.
          </li>
          <li>
            <strong>Form a Player's Name:</strong> Use the chosen letters to
            guess the hidden Premier League player's name.
          </li>
          <li>
            <strong>Substitute Letters:</strong> You can change up to 5 letters
            throughout the game by clicking the "Make a sub" button.
          </li>
          <li>
            <strong>Round Time:</strong> Each round has a time limit: 45 seconds
            for rounds 1 and 2, and 30 seconds for round 3.
          </li>
          <li>
            <strong>Submit Your Guess:</strong> Click the "Guess Player" button
            to submit your guess.
          </li>
          <li>
            <strong>Guesses per Round:</strong> You have 3 guesses available in
            each round.
          </li>
          <li>
            <strong>Scoring:</strong> Earn 1 point for each correct guess in
            rounds 1 and 2, and 3 points in round 3.
          </li>
          <li>
            <strong>Objective:</strong> Aim to achieve the highest score by
            accurately guessing the players within the time limit.
          </li>
        </ol>
        <button
          id="close-instructions"
          class="mt-6 w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300"
        >
          Got it!
        </button>
      </div>
    </div>

    <div
      id="guess-popup"
      class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-yellow-600 text-white p-4 rounded-lg shadow-lg text-center hidden"
    ></div>

    <script>
      class GameState {
        constructor() {
          this.chosenLetters = [];
          this.availableLetters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
          this.currentPlayer = "";
          this.displayedName = "";
          this.score = 0;
          this.substitutionsLeft = 5;
          this.timeLeft = 45;
          this.currentRound = 1;
          this.guessesLeft = 3;
          this.timerInterval = null;
          this.usedPlayers = [];
          this.usedLetters = new Set();
          this.pendingSubstitutions = {};
          this.allChosenLetters = new Set();
          this.playerList = {
            modernPlayers: [
              "ERLING HAALAND",
              "KEVIN DE BRUYNE",
              "MOHAMED SALAH",
              "BRUNO FERNANDES",
              "MARCUS RASHFORD",
              "JACK GREALISH",
              "BUKAYO SAKA",
              "VIRGIL VAN DIJK",
              "TRENT ALEXANDER ARNOLD",
              "HEUNG MIN SON",
              "RAHEEM STERLING",
              "PHIL FODEN",
              "GABRIEL JESUS",
              "RUBEN DIAS",
              "ANDREW ROBERTSON",
              "THIAGO SILVA",
              "MASON MOUNT",
              "DECLAN RICE",
              "JAMES MADDISON",
              "IVAN TONEY",
              "CALLUM WILSON",
              "KIERAN TRIPPIER",
              "OLLIE WATKINS",
              "JAMES WARD PROWSE",
              "GABRIEL MARTINELLI",
              "MARTIN ODEGAARD",
              "REECE JAMES",
              "RODRI",
              "BERNARDO SILVA",
              "EDERSON",
              "ALISSON BECKER",
              "AARON RAMSDALE",
              "ANTHONY GORDON",
              "COLE PALMER",
              "JOHN MCGINN",
              "WILLIAM SALIBA",
              "DOMINIC SOLANKE",
              "ALEXANDER ISAK",
              "JARROD BOWEN",
              "JEAN-PHILIPPE MATETA",
              "PEDRO NETO",
              "JULIAN ALVAREZ",
              "DARWIN NUNEZ",
              "RICHARLISON",
              "MOUSSA DIABY",
              "MICKY VAN DE VEN",
              "MIGUEL ALMIRON",
              "DOUGLAS LUIZ",
              "MORGAN GIBBS-WHITE",
              "PASCAL GROSS",
              "BRENNAN JOHNSON",
            ],
            legendPlayers: [
              "ALAN SHEARER",
              "THIERRY HENRY",
              "ERIC CANTONA",
              "STEVEN GERRARD",
              "FRANK LAMPARD",
              "RYAN GIGGS",
              "PATRICK VIEIRA",
              "ROY KEANE",
              "PETER SCHMEICHEL",
              "JOHN TERRY",
              "RIO FERDINAND",
              "PAUL SCHOLES",
              "WAYNE ROONEY",
              "DIDIER DROGBA",
              "DENNIS BERGKAMP",
              "DAVID BECKHAM",
              "CRISTIANO RONALDO",
              "VINCENT KOMPANY",
              "ASHLEY COLE",
              "NEMANJA VIDIC",
              "IAN WRIGHT",
              "ALAN HANSEN",
              "JAMIE CARRAGHER",
              "GARY NEVILLE",
              "MICHAEL OWEN",
              "ROBBIE FOWLER",
              "MATT LE TISSIER",
              "GIANFRANCO ZOLA",
              "PAULO DI CANIO",
              "RUUD VAN NISTELROOY",
              "EDWIN VAN DER SAR",
              "PETR CECH",
              "CLAUDE MAKELELE",
              "ROBERT PIRES",
              "FREDDIE LJUNGBERG",
              "SOL CAMPBELL",
              "ANDY COLE",
              "TEDDY SHERINGHAM",
              "LES FERDINAND",
              "TONY ADAMS",
            ],
            obscurePlayers: [
              "MICHU",
              "BENNI MCCARTHY",
              "PASCAL CHIMBONDA",
              "GEOVANNI",
              "AMDY FAYE",
              "ANDREJ KRAMARIC",
              "CLAUS LUNDEKVAM",
              "MORGAN AMALFITANO",
              "AFONSO ALVES",
              "NIKICA JELAVIC",
              "MAROUANE CHAMAKH",
              "ROQUE SANTA CRUZ",
              "TUGAY KERIMOGLU",
              "STELIOS GIANNAKOPOULOS",
              "JUSSI JAASKELAINEN",
              "BREDE HANGELAND",
              "THOMAS HITZLSPERGER",
              "BENOIT ASSOU EKOTTO",
              "TITUS BRAMBLE",
              "GIOVANNI VAN BRONCKHORST",
              "JONJO SHELVEY",
              "BRYAN RUIZ",
              "ADEL TAARABT",
              "KEVIN NOLAN",
              "CHARLIE ADAM",
              "DJIBRIL CISSE",
              "PAPISS CISSE",
              "DEMBA BA",
              "YANNICK BOLASIE",
              "STEVEN NZONZI",
              "SHOLA AMEOBI",
              "JAY JAY OKOCHA",
              "YOSSI BENAYOUN",
              "STEPHEN IRELAND",
              "JOEY BARTON",
              "FERNANDO FORESTIERI",
              "ANDROS TOWNSEND",
              "LEROY FER",
              "VICTOR MOSES",
            ],
          };
        }
        reset() {
          this.chosenLetters = [];
          this.score = 0;
          this.substitutionsLeft = 5;
          this.currentRound = 1;
          this.guessesLeft = 3;
          this.usedPlayers = [];
          this.usedLetters.clear();
          this.pendingSubstitutions = {};
          this.allChosenLetters.clear();
          this.timeLeft = 45;
          this.currentPlayer = "";
          this.displayedName = "";
          clearInterval(this.timerInterval);
        }
      }

      const gameState = new GameState();

      const letterGrid = document.getElementById("letter-grid");
      const playerNameEl = document.getElementById("player-name");
      const timerEl = document.getElementById("timer");
      const timerBar = document.getElementById("timer-bar");
      const scoreEl = document.getElementById("score");
      const substitutionsEl = document.getElementById("substitutions");
      const guessesLeftEl = document.getElementById("guesses-left");
      const solveBtn = document.getElementById("solve");
      const substituteBtn = document.getElementById("substitute");
      const newGameBtn = document.getElementById("new-game");
      const messageEl = document.getElementById("message");
      const roundInfoEl = document.getElementById("round-info");
      const currentTeamEl = document.getElementById("current-team");

      const substituteModal = document.getElementById("substituteModal");
      const solveModal = document.getElementById("solveModal");
      const substituteGrid = document.getElementById("substitute-grid");
      const newLettersGrid = document.getElementById("new-letters-grid");
      const solveInput = document.getElementById("solve-input");
      const submitSolveBtn = document.getElementById("submit-solve");
      const solveTimerEl = document.getElementById("solve-timer");
      const currentPlayerEl = document.getElementById("current-player");

      const howToPlayBtn = document.getElementById("how-to-play-btn");
      const instructionsModal = document.getElementById("instructionsModal");

      function toggleGameControls(show) {
        const gameControls = document.getElementById("game-controls");
        if (show) {
          gameControls.classList.remove("hidden");
          gameControls.classList.add("flex");
        } else {
          gameControls.classList.add("hidden");
          gameControls.classList.remove("flex");
        }
      }

      function startGame() {
        gameState.reset();
        updateScore();
        updateSubstitutions();
        updateGuessesLeft();
        resetTimerDisplay();
        roundInfoEl.textContent = `Round ${gameState.currentRound} of 3`;
        playerNameEl.textContent = "";
        letterGrid.innerHTML = "";
        document
          .getElementById("select-letters-text")
          .classList.remove("hidden");
        currentTeamEl.classList.add("hidden");
        document.getElementById("player-card").classList.add("hidden");
        document.getElementById("game-info-section").classList.add("hidden");
        toggleGameControls(false);
        document.getElementById("start-game").classList.add("hidden");
        messageEl.textContent = "Select 5 letters to start the game";
        newGameBtn.classList.add("hidden");

        letterGrid.classList.remove("hidden");

        substituteGrid.innerHTML = "";
        newLettersGrid.innerHTML = "";
        solveInput.value = "";

        selectInitialLetters();
      }

      function resetTimerDisplay() {
        timerEl.textContent = `Time: ${gameState.timeLeft}s`;
        timerBar.style.width = "100%";
        timerBar.classList.remove("pulse");
      }

      function selectInitialLetters() {
        letterGrid.innerHTML = "";
        gameState.availableLetters.forEach((letter) => {
          const button = document.createElement("button");
          button.textContent = letter;
          button.classList.add(
            "letter-btn",
            "bg-blue-600",
            "hover:bg-blue-500",
            "text-white",
            "font-bold",
            "py-2",
            "px-4",
            "rounded-lg",
            "transition",
            "duration-300"
          );
          button.addEventListener("click", () => toggleLetter(letter, button));
          letterGrid.appendChild(button);
        });
        updateCurrentTeam();

        gameState.chosenLetters = [];
        gameState.allChosenLetters.clear();
      }

      function toggleLetter(letter, button) {
        const index = gameState.chosenLetters.indexOf(letter);
        if (index === -1 && gameState.chosenLetters.length < 5) {
          gameState.chosenLetters.push(letter);
          button.classList.add("selected");
        } else if (index !== -1) {
          gameState.chosenLetters.splice(index, 1);
          button.classList.remove("selected");
        }
        updateCurrentTeam();
        if (gameState.chosenLetters.length === 5) {
          document.getElementById("start-game").classList.remove("hidden");
        } else {
          document.getElementById("start-game").classList.add("hidden");
        }
      }

      function updateCurrentTeam() {
        currentTeamEl.textContent = `Your current team: ${gameState.chosenLetters.join(
          ", "
        )}`;
      }

      function startRound() {
        const availablePlayers =
          gameState.currentRound === 1
            ? gameState.playerList.modernPlayers
            : gameState.currentRound === 2
            ? gameState.playerList.legendPlayers
            : gameState.playerList.obscurePlayers;

        do {
          gameState.currentPlayer =
            availablePlayers[
              Math.floor(Math.random() * availablePlayers.length)
            ];
        } while (gameState.usedPlayers.includes(gameState.currentPlayer));

        gameState.usedPlayers.push(gameState.currentPlayer);

        playerNameEl.classList.add("fade-out");
        setTimeout(() => {
          updateDisplayedName();
          playerNameEl.classList.remove("fade-out");
          playerNameEl.classList.add("fade-in");
        }, 500);

        roundInfoEl.classList.add("slide-in");

        gameState.timeLeft = gameState.currentRound === 3 ? 30 : 45;
        startTimer();
        updateRoundInfo();
        updateRoundMessage();
        updateMessage(
          `Round ${gameState.currentRound}: Guess the player! You have ${gameState.guessesLeft} guesses left.`
        );

        letterGrid.classList.add("hidden");
        document.getElementById("select-letters-text").classList.add("hidden");
        currentTeamEl.classList.remove("hidden");
        document.getElementById("player-card").classList.remove("hidden");
        document.getElementById("game-info-section").classList.remove("hidden");
        document.getElementById("start-game").classList.add("hidden");
        toggleGameControls(true);

        gameState.allChosenLetters.clear();
        gameState.chosenLetters.forEach((letter) =>
          gameState.allChosenLetters.add(letter.toUpperCase())
        );

        updateCurrentTeam();
        showGameInfoSection();
      }

      function updateRoundMessage() {
        let roundMessage;
        switch (gameState.currentRound) {
          case 1:
            roundMessage = "Guess the current Premier League player!";
            break;
          case 2:
            roundMessage = "Guess the Premier League legend!";
            break;
          case 3:
            roundMessage = "Guess the forgotten Premier League star!";
            break;
        }
        messageEl.textContent = roundMessage;
      }

      function updateDisplayedName() {
        const newDisplayedName = gameState.currentPlayer
          .split("")
          .map((char) =>
            char === " "
              ? " "
              : gameState.allChosenLetters.has(char.toUpperCase())
              ? `<span class="letter-reveal">${char}</span>`
              : "_"
          )
          .join("");

        if (playerNameEl.innerHTML !== newDisplayedName) {
          playerNameEl.innerHTML = newDisplayedName;
          playerNameEl
            .querySelectorAll(".letter-reveal")
            .forEach((span, index) => {
              span.style.transitionDelay = `${index * 100}ms`;
              setTimeout(() => (span.style.color = "white"), 50);
            });
        }
      }

      function startTimer() {
        clearInterval(gameState.timerInterval);
        const totalTime = gameState.currentRound === 3 ? 30 : 45;
        gameState.timerInterval = setInterval(() => {
          gameState.timeLeft--;
          updateTimerDisplay();
          if (gameState.timeLeft === 0) {
            clearInterval(gameState.timerInterval);
            updateMessage(
              `Time's up! The player was ${gameState.currentPlayer}. Moving to next round...`
            );
            setTimeout(endRound, 3000);
          }
        }, 1000);
      }

      function updateTimerDisplay() {
        timerEl.textContent = `Time: ${gameState.timeLeft}s`;
        const totalTime = gameState.currentRound === 3 ? 30 : 45;
        const percentage = (gameState.timeLeft / totalTime) * 100;
        timerBar.style.width = `${percentage}%`;
        if (gameState.timeLeft <= 10) {
          timerBar.classList.add("pulse");
        } else {
          timerBar.classList.remove("pulse");
        }
      }

      function substituteLetters() {
        if (gameState.substitutionsLeft > 0) {
          pauseTimer();
          gameState.pendingSubstitutions = {};
          showSubstituteOptions();
          openModal("substituteModal");
          updateCurrentPlayerDisplay();
        } else {
          updateMessage("No substitutions left!");
        }
      }

      function pauseTimer() {
        clearInterval(gameState.timerInterval);
      }

      function resumeTimer() {
        startTimer();
      }

      function showSubstituteOptions() {
        substituteGrid.innerHTML = "";
        gameState.chosenLetters.forEach((letter) => {
          const button = document.createElement("button");
          button.textContent = letter;
          button.classList.add(
            "letter-btn",
            "bg-blue-600",
            "hover:bg-blue-500",
            "text-white",
            "font-bold",
            "py-4",
            "px-6",
            "rounded-lg",
            "text-2xl",
            "transition",
            "duration-300"
          );
          if (gameState.pendingSubstitutions[letter]) {
            button.classList.remove("bg-blue-600", "hover:bg-blue-500");
            button.classList.add("bg-red-600", "hover:bg-red-500");
            button.textContent =
              gameState.pendingSubstitutions[letter] || letter;
          }
          button.addEventListener("click", () =>
            toggleLetterToReplace(letter, button)
          );
          substituteGrid.appendChild(button);
        });
        updateNewLettersGrid();
      }

      function toggleLetterToReplace(letter, button) {
        if (gameState.pendingSubstitutions[letter]) {
          // Unselect the letter
          delete gameState.pendingSubstitutions[letter];
          button.classList.remove(
            "bg-red-600",
            "hover:bg-red-500",
            "bg-green-600",
            "hover:bg-green-500"
          );
          button.classList.add("bg-blue-600", "hover:bg-blue-500");
          button.textContent = letter;
        } else {
          // Select the letter for substitution
          gameState.pendingSubstitutions[letter] = null;
          button.classList.remove("bg-blue-600", "hover:bg-blue-500");
          button.classList.add("bg-red-600", "hover:bg-red-500");
        }
        updateNewLettersGrid();
      }

      function updateNewLettersGrid() {
        newLettersGrid.innerHTML = "";
        const pendingSubCount = Object.values(
          gameState.pendingSubstitutions
        ).filter((v) => v === null).length;

        gameState.availableLetters.forEach((letter) => {
          if (
            !gameState.chosenLetters.includes(letter) &&
            !gameState.usedLetters.has(letter)
          ) {
            const button = document.createElement("button");
            button.textContent = letter;
            button.classList.add(
              "letter-btn",
              "bg-green-600",
              "hover:bg-green-500",
              "text-white",
              "font-bold",
              "py-4",
              "px-6",
              "rounded-lg",
              "text-2xl",
              "transition",
              "duration-300"
            );

            // Check if this letter has been selected as a replacement
            const isSelected = Object.values(
              gameState.pendingSubstitutions
            ).includes(letter);
            if (isSelected) {
              button.classList.remove("bg-green-600", "hover:bg-green-500");
              button.classList.add("bg-yellow-600", "hover:bg-yellow-500");
            }

            button.addEventListener("click", () =>
              selectNewLetter(letter, button)
            );

            // Enable all buttons, but style differently if no more substitutions are pending
            if (pendingSubCount === 0) {
              button.classList.add("opacity-50");
            } else {
              button.classList.remove("opacity-50");
            }

            newLettersGrid.appendChild(button);
          }
        });
        newLettersGrid.classList.remove("hidden");
      }

      function selectNewLetter(letter, button) {
        const oldLetter = Object.keys(gameState.pendingSubstitutions).find(
          (key) => gameState.pendingSubstitutions[key] === letter
        );

        if (oldLetter) {
          // Unselect this new letter
          gameState.pendingSubstitutions[oldLetter] = null;
          button.classList.remove("bg-yellow-600", "hover:bg-yellow-500");
          button.classList.add("bg-green-600", "hover:bg-green-500");

          // Reset the old letter button
          const oldButton = Array.from(substituteGrid.children).find(
            (btn) => btn.textContent === letter
          );
          if (oldButton) {
            oldButton.textContent = oldLetter;
            oldButton.classList.remove("bg-green-600", "hover:bg-green-500");
            oldButton.classList.add("bg-red-600", "hover:bg-red-500");
          }
        } else {
          // Select this letter as the replacement for the first pending substitution
          const pendingLetter = Object.keys(
            gameState.pendingSubstitutions
          ).find((key) => gameState.pendingSubstitutions[key] === null);
          if (pendingLetter) {
            gameState.pendingSubstitutions[pendingLetter] = letter;
            button.classList.remove("bg-green-600", "hover:bg-green-500");
            button.classList.add("bg-yellow-600", "hover:bg-yellow-500");

            // Update the display of the letter to be replaced
            const pendingButton = Array.from(substituteGrid.children).find(
              (btn) => btn.textContent === pendingLetter
            );
            if (pendingButton) {
              pendingButton.textContent = letter;
              pendingButton.classList.remove("bg-red-600", "hover:bg-red-500");
              pendingButton.classList.add("bg-green-600", "hover:bg-green-500");
            }
          }
        }
        updateNewLettersGrid();
      }

      function makeSubstitutions() {
        const substitutionCount = Object.keys(
          gameState.pendingSubstitutions
        ).length;
        if (
          substitutionCount > 0 &&
          substitutionCount <= gameState.substitutionsLeft
        ) {
          const oldLetters = [];
          const newLetters = [];
          Object.entries(gameState.pendingSubstitutions).forEach(
            ([oldLetter, newLetter]) => {
              if (newLetter) {
                oldLetters.push(oldLetter);
                newLetters.push(newLetter);
                const index = gameState.chosenLetters.indexOf(oldLetter);
                gameState.chosenLetters[index] = newLetter;
                gameState.usedLetters.add(oldLetter);
                gameState.usedLetters.add(newLetter);
                gameState.allChosenLetters.add(newLetter.toUpperCase());
              }
            }
          );
          gameState.substitutionsLeft -= substitutionCount;
          updateSubstitutions();
          updateCurrentTeam();
          updateDisplayedName();
          closeModal("substituteModal");
          resumeTimer();
          showSubstitutionFeedback(oldLetters, newLetters);
        } else if (substitutionCount > gameState.substitutionsLeft) {
          updateMessage(
            `You can only make ${gameState.substitutionsLeft} substitution(s)!`
          );
        } else {
          updateMessage("No substitutions selected!");
        }
      }

      function showSubstitutionFeedback(oldLetters, newLetters) {
        const feedbackEl = document.createElement("div");
        feedbackEl.classList.add(
          "text-center",
          "text-white",
          "my-4",
          "p-2",
          "bg-blue-600",
          "rounded"
        );
        feedbackEl.innerHTML = `Substituted: ${oldLetters.join(
          ", "
        )} ➡️ ${newLetters.join(", ")}`;
        document
          .getElementById("game-container")
          .insertBefore(feedbackEl, messageEl);
        setTimeout(() => feedbackEl.remove(), 3000);
      }

      function updateCurrentPlayerDisplay() {
        currentPlayerEl.textContent = gameState.currentPlayer
          .split("")
          .map((char) =>
            char === " "
              ? " "
              : gameState.allChosenLetters.has(char.toUpperCase())
              ? char
              : "_"
          )
          .join("");
      }

      let solveModalTimer;
      function openSolveModal() {
        openModal("solveModal");
        let timeLeft = 10;
        updateSolveModalTimer(timeLeft);
        solveModalTimer = setInterval(() => {
          timeLeft--;
          updateSolveModalTimer(timeLeft);
          if (timeLeft <= 0) {
            clearInterval(solveModalTimer);
            attemptSolve();
          }
        }, 1000);
      }

      function updateSolveModalTimer(time) {
        solveTimerEl.textContent = `Time left: ${time}s`;
      }

      function attemptSolve() {
        clearInterval(solveModalTimer);
        const guess = solveInput.value
          .toUpperCase()
          .replace(/\s+/g, " ")
          .trim();
        if (guess === gameState.currentPlayer) {
          gameState.score += gameState.currentRound === 3 ? 3 : 1;
          updateScore();
          showSuccessMessage("Correct! Well done!");
          endRound();
        } else {
          gameState.guessesLeft--;
          updateGuessesLeft();
          showIncorrectGuessPopup(guess);
          if (gameState.guessesLeft === 0) {
            setTimeout(endRound, 2000);
          }
        }
        solveInput.value = "";
        closeModal("solveModal");
      }

      function showIncorrectGuessPopup(guess) {
        const popup = document.getElementById("guess-popup");
        let message;
        switch (gameState.guessesLeft) {
          case 2:
            message = "That's a warning!";
            break;
          case 1:
            message = "Yellow card! Be careful!";
            break;
          case 0:
            message = "Red card! You're off!";
            break;
          default:
            message = "Incorrect guess!";
        }
        popup.textContent = `${message} Your guess: ${guess}`;
        popup.classList.remove("hidden");
        popup.classList.add("fade-in");
        setTimeout(() => {
          popup.classList.remove("fade-in");
          popup.classList.add("fade-out");
          setTimeout(() => {
            popup.classList.add("hidden");
            popup.classList.remove("fade-out");
          }, 500);
        }, 2000);
      }

      function showSuccessMessage(message) {
        const popup = document.getElementById("guess-popup");
        popup.textContent = message;
        popup.classList.remove("hidden", "bg-yellow-600");
        popup.classList.add("bg-green-600", "fade-in");
        setTimeout(() => {
          popup.classList.remove("fade-in");
          popup.classList.add("fade-out");
          setTimeout(() => {
            popup.classList.add("hidden");
            popup.classList.remove("fade-out", "bg-green-600");
            popup.classList.add("bg-yellow-600");
          }, 500);
        }, 2000);
      }

      function endRound() {
        clearInterval(gameState.timerInterval);
        playerNameEl.classList.add("fade-out");
        setTimeout(() => {
          if (gameState.currentRound < 3) {
            gameState.currentRound++;
            gameState.guessesLeft = 3;
            showRoundTransition();
          } else {
            endGame();
          }
        }, 500);
      }

      function showRoundTransition() {
        const transitionEl = document.createElement("div");
        transitionEl.classList.add(
          "fixed",
          "inset-0",
          "bg-black",
          "bg-opacity-75",
          "flex",
          "items-center",
          "justify-center",
          "text-white",
          "text-4xl",
          "font-bold"
        );
        transitionEl.innerHTML = `
      <div class="text-center">
        <p>Round ${gameState.currentRound - 1} completed!</p>
        <p class="mt-4">Current Score: ${gameState.score}</p>
        <p class="mt-8">Preparing Round ${gameState.currentRound}...</p>
      </div>
    `;
        document.body.appendChild(transitionEl);
        setTimeout(() => {
          document.body.removeChild(transitionEl);
          startRound();
        }, 3000);
      }

      function endGame() {
        clearInterval(gameState.timerInterval);
        updateMessage(`Game over! Final score: ${gameState.score}`);
        toggleGameControls(false);
        newGameBtn.classList.remove("hidden");
        playerNameEl.textContent = "";
        timerEl.textContent = "";
        roundInfoEl.textContent = "Game Over";
      }

      function updateScore() {
        scoreEl.textContent = `Score: ${gameState.score}`;
      }

      function updateSubstitutions() {
        substitutionsEl.textContent = `Subs: ${gameState.substitutionsLeft}`;
        substituteBtn.disabled = gameState.substitutionsLeft <= 0;
      }

      function updateGuessesLeft() {
        guessesLeftEl.textContent = `Guesses: ${gameState.guessesLeft}`;
      }

      function updateMessage(msg) {
        messageEl.textContent = msg;
      }

      function updateRoundInfo() {
        roundInfoEl.textContent = `Round ${gameState.currentRound} of 3`;
      }

      function openModal(modalId) {
        document.getElementById(modalId).classList.remove("hidden");
        document.getElementById(modalId).classList.add("flex");
        document
          .getElementById("game-container")
          .classList.add("blur-background");
        if (modalId === "solveModal") {
          pauseTimer();
          openSolveModal();
        } else if (modalId === "substituteModal") {
          pauseTimer();
        }
      }

      function closeModal(modalId) {
        document.getElementById(modalId).classList.add("hidden");
        document.getElementById(modalId).classList.remove("flex");
        document
          .getElementById("game-container")
          .classList.remove("blur-background");
        if (modalId === "solveModal") {
          clearInterval(solveModalTimer);
          resumeTimer();
        } else if (modalId === "substituteModal") {
          resumeTimer();
        }
      }

      function adjustLayoutForScreenSize() {
        const gameContainer = document.getElementById("game-container");
        if (window.innerWidth < 640) {
          gameContainer.classList.remove("max-w-4xl");
          gameContainer.classList.add("max-w-full");
        } else {
          gameContainer.classList.remove("max-w-full");
          gameContainer.classList.add("max-w-4xl");
        }
      }

      function showGameInfoSection() {
        document.getElementById("game-info-section").classList.remove("hidden");
      }

      // Event listeners
      solveBtn.addEventListener("click", () => openModal("solveModal"));
      substituteBtn.addEventListener("click", substituteLetters);
      submitSolveBtn.addEventListener("click", attemptSolve);
      newGameBtn.addEventListener("click", startGame);
      document
        .getElementById("start-game")
        .addEventListener("click", startRound);
      howToPlayBtn.addEventListener("click", () =>
        openModal("instructionsModal")
      );
      document
        .getElementById("close-instructions")
        .addEventListener("click", () => closeModal("instructionsModal"));
      document
        .getElementById("make-substitutions")
        .addEventListener("click", makeSubstitutions);

      solveInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          attemptSolve();
        }
      });

      window.addEventListener("resize", adjustLayoutForScreenSize);

      // Close modals when clicking outside
      window.onclick = function (event) {
        if (event.target.classList.contains("bg-black")) {
          const modalId = event.target.id;
          closeModal(modalId);
        }
      };

      // Start the game
      startGame();
      adjustLayoutForScreenSize();
    </script>
  </body>
</html>
